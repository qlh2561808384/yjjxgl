(function(b){var a=function(d,c){this.$wrap=d;this.$placeHolder;this.$queue;this.$statusBar;this.options=c;this.fileCount=0;this.fileSize=0;this.state="pedding";this.percentages={};this.$valueBox;this.$uploader;this.initWebUpload()};a.ratio=window.devicePixelRatio||1;a.DEFAULTS={isDel:false,isDownload:false,defaultView:"bigPic",url:"",delUrl:"",downloadUrl:"",fileIdKey:"fileId",thumbnailWidth:110*parseInt(a.ratio),thumbnailHeight:110*parseInt(a.ratio),paste:document.body,swf:"./Uploader.swf",chunked:false,chunkSize:512*1024,server:"../plugins/webuploader/webuploader.json",disableGlobalDnd:true,fileNumLimit:300,fileSizeLimit:200*1024*1024,fileSingleSizeLimit:50*1024*1024,onLoaded:function(c){}};a.prototype.initWebUpload=function(){var f=this.options,j=this;this.$wrap.addClass("uploader").append('<div class="queueList"><div class="dndArea placeholder"><div class="filePicker"></div><p>或将文件拖到这里，单次最多可选300个</p></div></div><div class="statusBar" style="display:none;"><div class="progress"><span class="text">0%</span><span class="percentage"></span></div><div class="info"></div><div class="btns"><div class="filePicker2"></div><div class="uploadBtn">开始上传</div></div></div>');var o=this.$wrap,k=f.name==undefined?"webupload":f.name,t=o.find(".queueList");this.$valueBox=b('<input type="hidden" class="valueBox" boxType="webupload" dname="'+k+'" name="'+k+'" />').appendTo(o);this.$placeHolder=o.find(".placeholder");this.$queue=b('<ul class="filelist"></ul>').appendTo(t);this.$statusBar=o.find(".statusBar");var e=this.$valueBox,h=this.$queue,g=this.$placeHolder,u=this.$statusBar,m=o.find(".filePicker"),i=o.find(".filePicker2"),d=u.find(".info"),n=u.find(".progress").hide(),c=o.find(".uploadBtn"),v=this.fileCount,l=this.fileSize,q=(function(){var y=new Image();var x=true;y.onload=y.onerror=function(){if(this.width!=1||this.height!=1){x=false}};y.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";return x})(),w=(function(){var x;try{x=navigator.plugins["Shockwave Flash"];x=x.description}catch(y){try{x=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(z){x="0.0"}}x=x.match(/\d+/g);return parseFloat(x[0]+"."+x[1],10)})(),s=(function(){var x=document.createElement("p").style,y="transition" in x||"WebkitTransition" in x||"MozTransition" in x||"msTransition" in x||"OTransition" in x;x=null;return y})(),p;if(!WebUploader.Uploader.support("flash")&&WebUploader.browser.ie){if(w){(function(x){window.expressinstallcallback=function(A){switch(A){case"Download.Cancelled":b.dalert({text:"您取消了更新！",icon:7});break;case"Download.Failed":b.dalert({text:"安装失败",icon:2});break;default:b.dalert({text:"安装已成功，请刷新！",icon:1});break}delete window.expressinstallcallback};var z="./expressInstall.swf";var y='<object type="application/x-shockwave-flash" data="'+z+'" ';if(WebUploader.browser.ie){y+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}y+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+z+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';x.html(y)})(o)}else{o.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>')}return}else{if(!WebUploader.Uploader.support()){b.dalert({text:"Web Uploader 不支持您的浏览器！",icon:2});return}}f.pick={id:m,innerHTML:"点击选择文件"};f.dnd=t;f=b.extend(true,{},a.DEFAULTS,f);this.$uploader=WebUploader.create(f);p=this.$uploader;h.addClass("view_"+f.defaultView);p.on("dndAccept",function(x){if(f.dndAccept===undefined){f.dndAccept=function(y){}}f.dndAccept.call(this,x)});p.addButton({id:i,label:"继续添加"});p.on("uploadAccept",function(y,x){if(f.uploadAccept===undefined){f.uploadAccept=function(B,A){}}j.addValue(x[f.fileIdKey]);y.file.fileId=x[f.fileIdKey];var z=b("#"+y.file.id).find(".download");if(z.length>0){z.find("a").attr({href:f.downloadUrl+"?id="+y.file.fileId})}f.uploadAccept.call(this,y,x)});function r(B){var D=j.appendFiles("newAdd",B),A=D.find("p.progress span"),C=D.find("p.imgWrap"),z=D.find(".file-panel"),y=b('<p class="error"></p>');var x=function(E){switch(E){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}y.text(text).appendTo(D)};if(B.getStatus()==="invalid"){x(B.statusText)}else{C.text("预览中");p.makeThumb(B,function(I,J){var F;if(I){var H=B.name,G=H.lastIndexOf(".");if(G!=-1){H=H.substring(G+1,H.length);var E=j.checkFileIcon(H);F=b('<span class="fa-file-wrap"><i class="fa '+E+'"></i></span>');C.empty().append(F).css({width:f.thumbnailWidth,height:f.thumbnailHeight+25});F.css({fontSize:f.thumbnailHeight/2,lineHeight:f.thumbnailHeight+"px"})}else{C.text("不能预览")}return}if(q){F=b('<img src="'+J+'">');C.empty().append(F)}else{b.ajax("../../server/preview.php",{method:"POST",data:J,dataType:"json"}).done(function(K){if(K.result){F=b('<img src="'+K.result+'">');C.empty().append(F)}else{C.text("预览出错")}})}},f.thumbnailWidth,f.thumbnailHeight);j.percentages[B.id]=[B.size,0];B.rotation=0}B.on("statuschange",function(F,E){if(E==="progress"){A.hide().width(0)}else{if(E==="queued"){if(!j.options.isDel&&!j.options.isDownload){D.off("mouseenter mouseleave");z.remove()}else{if(j.options.isDel&&!j.options.isDownload){z.find(".download").remove()}else{if(j.options.isDownload&&!j.options.isDel){z.find(".cancel").remove()}}}}}if(F==="error"||F==="invalid"){x(B.statusText);j.percentages[B.id][1]=1}else{if(F==="interrupt"){x("interrupt")}else{if(F==="queued"){j.percentages[B.id][1]=0}else{if(F==="progress"){y.remove();A.css("display","block")}else{if(F==="complete"){D.append('<span class="success"></span>')}}}}}D.removeClass("state-"+E).addClass("state-"+F)})}p.onUploadProgress=function(z,x){var A=b("#"+z.id),y=A.find(".progress span");y.css("width",x*100+"%");j.percentages[z.id][1]=x;j.updateTotalProgress()};p.onFileQueued=function(x){j.fileCount++;j.fileSize+=x.size;if(j.fileCount===1){g.addClass("element-invisible");u.show()}r(x);j.setState("ready");j.updateTotalProgress()};p.onFileDequeued=function(x){j.fileCount--;j.fileSize-=x.size;if(!j.fileCount){j.setState("pedding")}j.removeViewFile(x);j.updateTotalProgress();if(j.fileCount==0){j.$placeHolder.show().removeClass("element-invisible").find(":file").parent().css({width:"100%",height:"100%"});j.$statusBar.hide()}};p.on("all",function(y){var x;switch(y){case"uploadFinished":j.setState("confirm");break;case"startUpload":j.setState("uploading");break;case"stopUpload":j.setState("paused");break}});p.onError=function(y){var x="";if(y==="F_DUPLICATE"){x="文件队列中已有该文件"}else{if(y==="Q_TYPE_DENIED"){x="文件类型不匹配"}else{if(y==="Q_EXCEED_NUM_LIMIT"){x="文件总数量超出限制"}else{if(y==="Q_EXCEED_SIZE_LIMIT"){x="文件总大小超出限制"}else{if(y==="F_EXCEED_SIZE"){x="该文件大小超出限制"}}}}}b.dalert({text:x,icon:2})};c.on("click",function(){if(b(this).hasClass("disabled")){return false}if(j.state==="ready"){p.upload()}else{if(j.state==="paused"){p.upload()}else{if(j.state==="uploading"){p.stop()}}}});d.on("click",".retry",function(){p.retry()});d.on("click",".ignore",function(){if(f.onIgnore){f.onIgnore(this,p)}});c.addClass("state-"+j.state);j.updateTotalProgress()};a.prototype.setState=function(e){var j=this,g=j.$statusBar,k=g.find(".uploadBtn"),l=g.find(".progress"),m=j.$placeHolder,i=j.$queue,d=j.$uploader,c=j.$wrap.find(".filePicker2");var f,h;if(e===j.state){return}k.removeClass("state-"+j.state);k.addClass("state-"+e);j.state=e;switch(j.state){case"pedding":m.removeClass("element-invisible");i.hide();g.addClass("element-invisible");d.refresh();break;case"ready":m.addClass("element-invisible");c.removeClass("element-invisible");i.show();g.removeClass("element-invisible");d.refresh();break;case"uploading":c.addClass("element-invisible");l.show().css({display:"inline-block"});k.text("暂停上传");break;case"paused":l.show().css({display:"inline-block"});k.text("继续上传");break;case"confirm":l.hide();c.removeClass("element-invisible");k.text("开始上传");h=d.getStats();if(h.successNum&&!h.uploadFailNum){j.setState("finish");return}break;case"finish":h=d.getStats();if(h.successNum){b.dalert({text:"上传成功",icon:1})}else{j.state="done";location.reload()}break}j.updateStatus()};a.prototype.removeViewFile=function(c){var d=b("#"+c.id);delete this.percentages[c.id];this.updateTotalProgress();d.off().find(".file-panel").off().end().remove()};a.prototype.updateTotalProgress=function(){var c=0,f=0,d=this.$statusBar.find(".progress").children(),e;b.each(this.percentages,function(h,g){f+=g[0];c+=g[0]*g[1]});e=f?c/f:0;d.eq(0).text(Math.round(e*100)+"%");d.eq(1).css("width",Math.round(e*100)+"%");this.updateStatus()};a.prototype.updateStatus=function(){var e=this,f="",d,g=e.fileCount,c=e.fileSize;if(e.state==="ready"){f="选中"+g+"个文件，共"+WebUploader.formatSize(c)+"。"}else{if(e.state==="confirm"){d=e.$uploader.getStats();if(d.uploadFailNum){f="已成功上传"+d.successNum+"个文件，"+d.uploadFailNum+'个文件上传失败，<a class="retry" href="#">重新上传</a>失败文件或<a class="ignore" href="#">忽略</a>'}}else{d=e.$uploader.getStats();f="共"+g+"个文件（"+WebUploader.formatSize(c)+"），已上传"+e.$wrap.find(".state-complete").length+"个文件";if(d.uploadFailNum){f+="，失败"+d.uploadFailNum+"个文件"}}}this.$wrap.find(".info").html(f)};a.prototype.showToggleBtn=function(g){var e=this,l=e.options,d=this.$queue,c=this.$wrap.find(".filePicker2");if(g=="show"){if(e.$wrap.find(".switchViewBtn").length===0){var h=b('<div class="switchViewBtn"><i class="fa"></i></div>').prependTo(c.parent()),j=h.find(".fa"),i="fa-th-large",f="fa-list-ul";if(l.defaultView==="bigPic"){j.addClass(i)}else{j.addClass(f)}h.on("click",function(){if(j.hasClass(f)){j.removeClass(f).addClass(i);d.addClass("view_bigPic").removeClass("view_detailList");d.prev().hide();e.setView(true)}else{j.removeClass(i).addClass(f);d.removeClass("view_bigPic").addClass("view_detailList");d.prev().show();e.setView(false)}});var k=b('<ul class="view_detailList list-unstyled"><li class="detailList_hd"><p class="title">文件名称</p><p class="uploadDate">上传日期</p><p class="type">文件类型</p><p class="size">文件大小</p></li></ul>').hide();d.before(k)}}else{this.$wrap.find(".switchViewBtn").remove();this.$wrap.find(".detailList_hd").remove()}};a.prototype.deleteFile=function(e){var f=this,d=this.options,g=b("#"+e.id),c=g.index();b.dopen({type:0,title:"删除",content:"确定删除？",btn:["确定","取消"],btn1:function(h){if(g.hasClass("state-complete")){b.dajax({url:d.delUrl+"?id="+e.fileId,success:function(j){f.removeViewFile(e);var i=f.$valueBox.val().split(",");i.splice(c,1);f.$valueBox.val(i.join(","));f.$uploader.removeFile(e)}})}else{f.$uploader.removeFile(e)}layer.close(h)}})};a.prototype.loadData=function(c){if(c==undefined){return}var e=this,f=this.$queue,d=this.$wrap.find(".info");this.$placeHolder.hide();this.$statusBar.show().find(":file").parent().css({width:"100%",height:"100%"});b.dajax({url:c,success:function(i){var j=0,g=0,h="";f.empty();b.each(i,function(l){h+=i[l].fileId+",";var k=e.getWuFile(i[l]);k.fileId=i[l].fileId;j++;g+=k.size;e.appendFiles("loadData",k)});e.$placeHolder.addClass("element-invisible");e.setView(true);d.html("共"+j+"个文件（"+WebUploader.formatSize(g)+"）");e.fileCount=f.find("li").length;e.fileSize=g;e.$valueBox.val("");e.addValue(h.substring(0,h.length-1))}})};a.prototype.appendFiles=function(d,h){var l,j=this,i=this.$queue;if(d==="newAdd"){l=b('<li id="'+h.id+'"><p class="imgWrap"></p><p class="title">'+h.name+'</p><p class="uploadDate">'+j.formatDate(h.uploadDate)+'</p><p class="type">'+h.type+'</p><p class="size">'+WebUploader.formatSize(h.size)+'</p><p class="progress"><span></span></p></li>')}else{if(d==="loadData"){var e=h.name,k=e.lastIndexOf("."),f=e.substring(k+1,e.length),m=j.checkFileIcon(f);l=b('<li id="'+h.id+'" class="state-complete"><p class="imgWrap"><span class="fa-file-wrap"><i class="fa '+m+'"></i></span></p><p class="title">'+h.name+'</p><p class="uploadDate">'+j.formatDate(h.uploadDate)+'</p><p class="type">'+h.type+'</p><p class="size">'+WebUploader.formatSize(h.size)+'</p><p class="progress"><span></span></p><span class="success"></span></li>')}}var c=j.setPanelBtns(d,h),g=b(c).appendTo(l);if(g.children().length>0){l.on("mouseenter",function(){g.stop().animate({height:30})}).on("mouseleave",function(){g.stop().animate({height:0})});g.on("click","span",function(){var n=b(this).index();switch(n){case 0:if(b(this).hasClass("delDisabled")){b.dalert({text:"禁用状态下不可删除",icon:2})}else{j.deleteFile(h)}return}})}l.appendTo(i);return l};a.prototype.setPanelBtns=function(g,e){var d='<div class="file-panel">',c=this.options,f=c.downloadUrl+"?id="+e.fileId;if(g==="newAdd"){d+='<span class="cancel"><i class="fa fa-trash-o"></i></span>';d+='<span class="download"><a href="" target="_blank"><i class="fa fa-download"></i></a></span>'}else{if(g==="loadData"){if(this.options.isDel){d+='<span class="cancel"><i class="fa fa-trash-o"></i></span>'}if(this.options.isDownload){d+='<span class="download"><a href="'+f+'" target="_blank"><i class="fa fa-download"></i></a></span>'}}}d+="</div>";return d};a.prototype.addValue=function(e){var d=this.getValue(),c=d===""?"":",";this.$valueBox.val(d+c+e)};a.prototype.setValue=function(d){var c=this.options;this.$queue.empty().removeClass("view_detailList").addClass("view_bigPic");this.$valueBox.val("");if(d==null||d==undefined){return}this.loadData(c.url+"?id="+d)};a.prototype.getValue=function(){return this.$valueBox.val()};a.prototype.disable=function(){var c=this;var d=setInterval(function(){if(c.$wrap.find(":file").length>0){c.$uploader.disable();c.$wrap.addClass("disabledUpload").find(".uploadBtn").addClass("disabled");c.$wrap.find(".cancel").addClass("delDisabled");c.showToggleBtn("show");clearInterval(d)}},10)};a.prototype.enable=function(){this.$uploader.enable();this.$wrap.removeClass("disabledUpload").find(".uploadBtn").removeClass("disabled");this.$wrap.find(".cancel").removeClass("delDisabled");this.showToggleBtn("hide");this.$queue.removeClass("view_detailList").addClass("view_bigPic");this.setView(true)};a.prototype.destroy=function(){this.fileCount=0;this.fileSize=0;this.$uploader.destroy();this.$wrap.remove()};a.prototype.clear=function(){var c=this.$uploader,d=this.$uploader.getFiles();b.each(d,function(e){c.removeFile(d[e])});this.setState("pedding");this.$valueBox.val("");this.$queue.empty();this.$placeHolder.show().removeClass("element-invisible").find(":file").parent().css({width:"100%",height:"100%"});this.$statusBar.hide();this.fileCount=0;this.fileSize=0};a.prototype.validate=function(){var c=true,h=b.trim(this.$valueBox.val()),g=this,d=this.options;var f=this.$queue.find("li.state-complete").length,e=this.$queue.find("li").length;if(f<e){layer.tips("还有文件未上传成功",this.$wrap,{tipsMore:true,time:2000});this.$wrap.addClass("has-error");return false}if(d.required&&h==""){layer.tips("该选项为必填",this.$wrap,{tipsMore:true,time:2000});this.$wrap.addClass("has-error");return false}if(c){this.$wrap.removeClass("has-error")}else{this.$wrap.addClass("has-error")}return c};a.prototype.getWuFile=function(c){return new WebUploader.File(new WebUploader.Lib.File(WebUploader.guid("rt_"),c))};a.prototype.formatDate=function(e){if(typeof e==="object"){var g=e.getFullYear(),h=e.getMonth()+1<10?"0"+(e.getMonth()+1):(e.getMonth()+1),d=e.getDate()<10?"0"+e.getDate():e.getDate(),c=e.getHours()<10?"0"+e.getHours():e.getHours(),f=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes();return g+"-"+h+"-"+d+" "+c+":"+f}else{if(typeof e==="string"){return e}}};a.prototype.setView=function(c){var d=this.options,e=this.$queue;if(c){e.find(".imgWrap").css({width:d.thumbnailWidth,height:d.thumbnailHeight+25});e.find(".fa-file-wrap").css({fontSize:d.thumbnailHeight/2,lineHeight:d.thumbnailHeight+"px"})}else{e.find(".imgWrap").removeAttr("style");e.find(".fa-file-wrap").removeAttr("style")}};a.prototype.checkFileIcon=function(d){var c="";switch(d){case"gif":case"jpg":case"jpeg":case"bmp":case"png":c="fa-file-image-o";break;case"xlsx":case"xls":c="fa-file-excel-o";break;case"pdf":c="fa-file-pdf-o";break;case"ppt":c="fa-file-powerpoint-o";break;case"txt":c="fa-file-text-o";break;case"doc":case"docx":c="fa-file-word-o";break;case"zip":case"rar":c="fa-file-zip-o";break;default:c="fa-file-o"}return c};b.fn.webupload=function(c){var g=b.replaceTag(b(this),"DIV");if(typeof c=="object"){b.include([__bootstrapVersionPath+"/plugins/webuploader/webuploader.js",__bootstrapVersionPath+"/plugins/webuploader/webuploader.css",__bootstrapVersionPath+"/css/font-awesome.min.css"]);c=b.extend(true,{},a.DEFAULTS,c);var f=new a(g,c);g.data("webupload",f);c.onLoaded.call(this,f);return f}else{if(typeof c=="string"){var d,h=Array.prototype.slice.call(arguments,1),e=g.data("webupload");d=e[c].apply(e,h);return typeof d==="undefined"?this:d}}}})(jQuery);